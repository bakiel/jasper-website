"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[766],{5359:function(e,t,n){n.d(t,{z2:function(){return _},cv:function(){return h},kx:function(){return f},Tg:function(){return w},iR:function(){return y},Mp:function(){return k},qx:function(){return p},f$:function(){return S}});let o="csrf_token",a="csrf_token";function i(){let e;let t=((e=sessionStorage.getItem(o))||(e=function(){let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}(),sessionStorage.setItem(o,e)),function(e){let t="https:"===window.location.protocol?"; Secure":"";document.cookie="".concat(a,"=").concat(e,"; Path=/; SameSite=Strict").concat(t)}(e),e);return t?{"X-CSRF-Token":t}:{}}let r={default:{maxRequests:60,windowMs:6e4,retryAfterMs:5e3},auth:{maxRequests:5,windowMs:6e4,retryAfterMs:1e4},upload:{maxRequests:10,windowMs:6e4,retryAfterMs:1e4},search:{maxRequests:30,windowMs:6e4,retryAfterMs:3e3}},s=new Map;function c(e){return e.includes("/auth/")?"auth":e.includes("/upload")?"upload":e.includes("/search")?"search":"default"}function l(e){let t=s.get(e);return t||(t={count:0,windowStart:Date.now(),retryAfter:null},s.set(e,t)),t}class u extends Error{constructor(e,t){super(e),this.name="RateLimitError",this.retryAfterMs=t}}let d="/api/v1";function g(){return localStorage.getItem("admin_token")}async function m(e,t){if(!function(e){let t=c(e),n=r[t],o=l(t),a=Date.now();return(!o.retryAfter||!(a<o.retryAfter))&&(a-o.windowStart>=n.windowMs&&(o.count=0,o.windowStart=a,o.retryAfter=null),o.count<n.maxRequests)}(e))throw new u("Too many requests. Please wait a moment before trying again.",5e3);let n=g(),o=(null==t?void 0:t.method)||"GET",a={"Content-Type":"application/json",...null==t?void 0:t.headers};n&&(a.Authorization="Bearer ".concat(n)),["GET","HEAD","OPTIONS"].includes(o.toUpperCase())||Object.assign(a,i()),function(e){let t=l(c(e));t.count++}(e);let s=await fetch("".concat(d).concat(e),{headers:a,...t});if(!s.ok){if(429===s.status){let t=function(e,t){let n=c(e),o=r[n],a=l(n),i=o.retryAfterMs;if(t){let e=parseInt(t,10);isNaN(e)||(i=1e3*e)}return a.retryAfter=Date.now()+i,i}(e,s.headers.get("Retry-After"));throw new u("Too many requests. Please wait ".concat(Math.ceil(t/1e3)," seconds."),t)}401===s.status&&(localStorage.removeItem("admin_token"),localStorage.removeItem("admin_user"));let t=await s.json().catch(()=>({message:"Request failed"}));throw Error(t.detail||t.message||"Request failed")}return s.json()}let f={getMetrics:()=>m("/admin/dashboard"),getAnalytics:()=>m("/admin/analytics")},h={list:e=>{let t=new URLSearchParams;return(null==e?void 0:e.page)&&t.set("page",e.page.toString()),(null==e?void 0:e.page_size)&&t.set("page_size",e.page_size.toString()),(null==e?void 0:e.status)&&t.set("status",e.status),m("/clients/?".concat(t))},get:e=>m("/clients/".concat(e)),create:e=>m("/clients/",{method:"POST",body:JSON.stringify(e)}),update:(e,t)=>m("/clients/".concat(e),{method:"PATCH",body:JSON.stringify(t)}),sendInvite:(e,t)=>m("/clients/".concat(e,"/send-invite"),{method:"POST",body:JSON.stringify({contact_id:t})}),getContacts:e=>m("/clients/".concat(e,"/contacts"))},p={list:e=>{let t=new URLSearchParams;return(null==e?void 0:e.page)&&t.set("page",e.page.toString()),(null==e?void 0:e.page_size)&&t.set("page_size",e.page_size.toString()),(null==e?void 0:e.company_id)&&t.set("company_id",e.company_id.toString()),(null==e?void 0:e.stage)&&t.set("stage",e.stage),m("/projects/?".concat(t))},get:e=>m("/projects/".concat(e)),create:e=>m("/projects/",{method:"POST",body:JSON.stringify(e)}),update:(e,t)=>m("/projects/".concat(e),{method:"PATCH",body:JSON.stringify(t)}),getMilestones:e=>m("/projects/".concat(e,"/milestones")),getTimeline:e=>m("/projects/".concat(e,"/timeline")),updateMilestone:(e,t,n)=>m("/projects/".concat(e,"/milestones/").concat(t),{method:"PATCH",body:JSON.stringify(n)}),advanceStage:e=>m("/projects/".concat(e,"/advance-stage"),{method:"POST"})},y={list:e=>{let t=new URLSearchParams;return(null==e?void 0:e.page)&&t.set("page",e.page.toString()),(null==e?void 0:e.page_size)&&t.set("page_size",e.page_size.toString()),(null==e?void 0:e.company_id)&&t.set("company_id",e.company_id.toString()),(null==e?void 0:e.status)&&t.set("status",e.status),m("/invoices/?".concat(t))},get:e=>m("/invoices/".concat(e)),create:e=>m("/invoices/",{method:"POST",body:JSON.stringify(e)}),markPaid:(e,t)=>m("/invoices/".concat(e,"/mark-paid"),{method:"POST",body:JSON.stringify(t)})},w={listByProject:e=>m("/documents/project/".concat(e)),upload:async e=>{let t=g(),n={...i()};t&&(n.Authorization="Bearer ".concat(t));let o=await fetch("/api/v1/documents/upload",{method:"POST",headers:n,body:e});if(!o.ok)throw Error((await o.json().catch(()=>({detail:"Upload failed"}))).detail||"Upload failed");return o.json()},delete:e=>m("/documents/".concat(e),{method:"DELETE"}),download:e=>"/api/v1/documents/".concat(e,"/download")},S={getStatus:()=>m("/questionnaire/status"),get:()=>m("/questionnaire/"),save:e=>m("/questionnaire/",{method:"POST",body:JSON.stringify(e)})},_={login:async(e,t)=>{let n=await fetch("".concat(d,"/admin/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!n.ok)throw Error((await n.json().catch(()=>({detail:"Login failed"}))).detail||"Invalid credentials");let o=await n.json();return localStorage.setItem("admin_token",o.access_token),localStorage.setItem("admin_user",JSON.stringify(o.user)),o},googleLogin:async e=>{let t=await fetch("".concat(d,"/admin/auth/google"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:e})});if(!t.ok)throw Error((await t.json().catch(()=>({detail:"Google login failed"}))).detail||"Google authentication failed");let n=await t.json();return localStorage.setItem("admin_token",n.access_token),localStorage.setItem("admin_user",JSON.stringify(n.user)),n},getGoogleClientId:async()=>{let e=await fetch("".concat(d,"/admin/auth/google/client-id"));if(!e.ok)throw Error("Google OAuth not configured");return(await e.json()).client_id},linkedinLogin:async(e,t)=>{let n=await fetch("".concat(d,"/admin/auth/linkedin"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:"linkedin",code:e,redirect_uri:t})});if(!n.ok){let e=await n.json().catch(()=>({detail:"LinkedIn login failed"}));throw Error((e.error?"".concat(e.detail,": ").concat(e.error):e.detail)||"LinkedIn authentication failed")}let o=await n.json();return localStorage.setItem("admin_token",o.access_token),localStorage.setItem("admin_user",JSON.stringify(o.user)),o},getLinkedInConfig:async()=>{let e=await fetch("".concat(d,"/admin/auth/linkedin/client-id"));if(!e.ok)throw Error("LinkedIn OAuth not configured");return e.json()},logout:()=>{localStorage.removeItem("admin_token"),localStorage.removeItem("admin_user"),sessionStorage.removeItem(o),document.cookie="".concat(a,"=; Path=/; Max-Age=0"),s.clear(),window.location.href="/login"},getCurrentUser:()=>{let e=localStorage.getItem("admin_user");if(!e)return null;try{return JSON.parse(e)}catch(e){return null}},isAuthenticated:()=>!!localStorage.getItem("admin_token"),getMe:()=>m("/admin/auth/me"),changePassword:(e,t)=>m("/admin/auth/change-password",{method:"POST",body:JSON.stringify({current_password:e,new_password:t})})},k={send:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Admin",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return m("/messages/send?sender_name=".concat(encodeURIComponent(t),"&sender_id=").concat(n),{method:"POST",body:JSON.stringify(e)})},getThreads:e=>m("/messages/threads".concat(e?"?company_id=".concat(e):"")),getCompanyMessages:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=new URLSearchParams;return o.set("page",n.toString()),t&&o.set("project_id",t.toString()),m("/messages/company/".concat(e,"?").concat(o))},getMessage:e=>m("/messages/".concat(e)),getReplies:e=>m("/messages/".concat(e,"/replies")),markAsRead:e=>m("/messages/".concat(e,"/read"),{method:"PATCH"}),markAllAsRead:e=>m("/messages/company/".concat(e,"/read-all"),{method:"PATCH"})}},7766:function(e,t,n){n.d(t,{AuthProvider:function(){return l},a:function(){return u}});var o=n(7437),a=n(2265),i=n(9376),r=n(5359);let s=(0,a.createContext)(void 0),c=["/login","/intake"];function l(e){let{children:t}=e,[n,l]=(0,a.useState)(null),[u,d]=(0,a.useState)(!0),g=(0,i.useRouter)(),m=(0,i.usePathname)(),f=(0,a.useRef)(!1),h=(0,a.useRef)(!1);(0,a.useEffect)(()=>{(async()=>{if(h.current||f.current){d(!1);return}h.current=!0;try{let e=r.z2.getCurrentUser();if(e&&r.z2.isAuthenticated()){l(e),d(!1),setTimeout(async()=>{if(!f.current)try{let e=await r.z2.getMe();l(e),localStorage.setItem("admin_user",JSON.stringify(e))}catch(e){console.error("Background token verification failed:",e),f.current||(r.z2.logout(),l(null))}},1e3);return}l(null)}catch(e){console.error("Auth check failed:",e),l(null)}finally{d(!1)}})()},[]),(0,a.useEffect)(()=>{if(!u){let e=c.some(e=>m===e);n||e?n&&"/login"===m&&g.push("/"):g.push("/login")}},[n,u,m,g]);let p=async(e,t)=>{f.current=!0;try{let n=await r.z2.login(e,t);l(n.user),await new Promise(e=>setTimeout(e,150)),g.push("/")}finally{setTimeout(()=>{f.current=!1},2e3)}},y=async e=>{f.current=!0;try{let t=await r.z2.googleLogin(e);l(t.user),await new Promise(e=>setTimeout(e,150)),g.push("/")}finally{setTimeout(()=>{f.current=!1},2e3)}},w=async(e,t)=>{f.current=!0;try{let n=await r.z2.linkedinLogin(e,t);l(n.user),await new Promise(e=>setTimeout(e,150)),g.push("/")}finally{setTimeout(()=>{f.current=!1},2e3)}};return(0,o.jsx)(s.Provider,{value:{user:n,isLoading:u,isAuthenticated:!!n,login:p,googleLogin:y,linkedinLogin:w,logout:()=>{l(null),r.z2.logout()}},children:t})}function u(){let e=(0,a.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);